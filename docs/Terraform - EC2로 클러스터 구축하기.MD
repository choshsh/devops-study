AWS í™˜ê²½ì— EC2ë¡œ ë§¤ë‰´ì–¼í•˜ê²Œ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤.

- AWS IaC ë„êµ¬ : terraform
- í´ëŸ¬ìŠ¤í„° ìƒì„± ë„êµ¬ : kubeadm
- ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ : containerd
- í¼ì‹œìŠ¤í„´íŠ¸ ë³¼ë¥¨ ë“œë¼ì´ë²„ : Amazon EBS CSI

## ì‚¬ì „ ì¤€ë¹„

1. aws-cli [ì„¤ì¹˜](https://docs.aws.amazon.com/ko_kr/cli/latest/userguide/install-cliv2.html) ë° [ì„¤ì •](https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started#prerequisites)
2. [terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli) ì„¤ì¹˜

## ì‹œì‘í•˜ê¸°

### 1. aws ë¦¬ì†ŒìŠ¤

1. ê¸°ë³¸ êµ¬ì„± ë° ëª¨ë“ˆ ì„¤ì¹˜
    
    <aside>
    ğŸ’¡ ì‚¬ì „ì— `provider.tf`ì˜ `backend`ëŠ” ìˆ˜ì • ë˜ëŠ” ì‚­ì œ
    
    </aside>
    
    ```bash
    cd terraform/kubernetes-ec2
    terraform init
    ```
    
2. [ssh í‚¤í˜ì–´ ìƒì„±](https://www.ssh.com/academy/ssh/keygen) - public keyë¥¼ ec2 ë””ë ‰í† ë¦¬ ì•ˆì— `aws-key.pub` íŒŒì¼ëª…ìœ¼ë¡œ ìœ„ì¹˜
3. ì‚¬ì „ ê²€ì¦
    
    ```bash
    terraform plan --var-file choshsh.tfvars
    ```
    
4. ë°°í¬
    
    ```bash
    terraform apply --var-file choshsh.tfvars
    ```
    
5. í™•ì¸
    
    ec2ê°€ ìƒì„±ë  ë•Œ  `ec2/install_k8s.sh` ìŠ¤í¬ë¦½íŠ¸ê°€  ì‹¤í–‰ë˜ë©´ì„œ  kubeadm, kubelet, kubectl, containerd ë“±ì„ ìë™ìœ¼ë¡œ ì„¤ì¹˜í•˜ê³  ì„¤ì •í•©ë‹ˆë‹¤.
    
    - ì¶œë ¥ëœ EC2 public dns ì£¼ì†Œë¡œ ssh secret í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ 22ë²ˆ í¬íŠ¸ë¡œ ssh ì ‘ì†
    - kubernetes ê´€ë ¨ íŒ¨í‚¤ì§€, containerd ìƒíƒœ í™•ì¸

### 2. kubernetes í´ëŸ¬ìŠ¤í„°

1. ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ kubeadm ì„¤ì •íŒŒì¼ ìƒì„±
    - cloud-providerì™€ cluster-cidrì„ ì„¤ì •
    - kube-proxy `ipvs` ëª¨ë“œë¥¼ ì‚¬ìš©
    
    ```bash
    curl https://gist.githubusercontent.com/choshsh/de1e2e7c8376ca43bee25fec033bac4d/raw/kubeadm.yaml >kubeadm.yaml
    ```
    
    [https://gist.github.com/choshsh/de1e2e7c8376ca43bee25fec033bac4d#file-kubeadm-yaml](https://gist.github.com/choshsh/de1e2e7c8376ca43bee25fec033bac4d#file-kubeadm-yaml)
    
2. ì‚¬ì „ ê²€ì¦
    
    ```bash
    sudo kubeadm init --config kubeadm.yaml --dry-run
    ```
    
3. kubeadm init ë° join
    
    ```bash
    sudo kubeadm init --config kubeadm.yaml
    ```
    
4. ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ (CIDR `10.244.0.0/16`)

### 3. istio (with helm)

*Elastic Load Balancing*ì™€ *Certificate Manager*ë¥¼ istio ingress-gatewayì™€ ì—°ë™í•˜ì—¬ íŠ¸ë˜í”½ì„ ë°›ìŠµë‹ˆë‹¤.

1. [ì„¤ì¹˜](https://istio.io/latest/docs/setup/install/helm/) (â—ingress ë°°í¬ ì „ê¹Œì§€ë§Œ)
2. ingress-gateway
    - aws ë¡œë“œë°¸ëŸ°ì„œì™€ acm ì‚¬ìš©ì„ ìœ„í•œ `override.yaml` íŒŒì¼ ìƒì„±
        
        ```bash
        # override.yaml
        gateways:
          istio-ingressgateway:
            type: "NodePort"
            ports:
            - port: 15021
              targetPort: 15021
              name: status-port
              nodePort: 30021
              protocol: TCP
            - port: 80
              targetPort: 8080
              name: http2
              protocol: TCP
              nodePort: 30080
            - port: 443
              targetPort: 8443
              name: https
              protocol: TCP
              nodePort: 30443
        ```
        
    - ë°°í¬
        
        ```bash
        helm install istio-ingress manifests/charts/gateways/istio-ingress -f override.yaml -n istio-system
        ```
        
    - í™•ì¸
        
        ```bash
        $ kubectl describe svc -n istio-system istio-ingressgateway
        ...
        Events:
          Type    Reason                Age   From                Message
          ----    ------                ----  ----                -------
          Normal  EnsuringLoadBalancer  20s   service-controller  Ensuring load balancer
          Normal  EnsuredLoadBalancer   16s   service-controller  Ensured load balancer
        
        $ kubectl get svc -n istio-system istio-ingressgateway
        NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP                                                                          PORT(S)                                      AGE
        istio-ingressgateway   LoadBalancer   10.97.145.74   a5e546ad78d62418399254d6486c37b0-17e32feb74ff9e63.elb.ap-northeast-2.amazonaws.com   15021:32220/TCP,80:30950/TCP,443:31078/TCP   55s
        ```
        

### 4. Amazon EBS CSI ë“œë¼ì´ë²„

í´ë¼ìš°ë“œ ë””ìŠ¤í¬ë¥¼ ì‚¬ìš©í•˜ì—¬ í¼ì‹œìŠ¤í„´íŠ¸ë³¼ë¥¨ì„ ë™ì ìœ¼ë¡œ í”„ë¡œë¹„ì €ë‹í•©ë‹ˆë‹¤.

1. ë“œë¼ì´ë²„ ë°°í¬
    
    ```bash
    helm repo add aws-ebs-csi-driver https://kubernetes-sigs.github.io/aws-ebs-csi-driver
    helm repo update
    ```
    
    ```bash
    helm upgrade -install aws-ebs-csi-driver aws-ebs-csi-driver/aws-ebs-csi-driver \
    --namespace kube-system \
    --set image.repository=602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/eks/aws-ebs-csi-driver \
    --set enableVolumeResizing=true \
    --set enableVolumeSnapshot=true \
    --set serviceAccount.controller.create=true \
    --set serviceAccount.controller.name=ebs-csi-controller-sa
    ```
    
2. ìŠ¤í† ë¦¬ì§€í´ë˜ìŠ¤ ë°°í¬
    
    ```bash
    kubectl apply -f https://gist.github.com/choshsh/e321761b43b5646821d3c2a6c18715f7/raw/050eeb128038ca382d2760288a324de3bb3a71ce/csi-driver-sc.yaml
    ```
    
    [https://gist.github.com/choshsh/e321761b43b5646821d3c2a6c18715f7#file-csi-driver-sc-yaml](https://gist.github.com/choshsh/e321761b43b5646821d3c2a6c18715f7#file-csi-driver-sc-yaml)